FROM tomcat:6

# Install packetbeat
RUN apt-get update && \
    apt-get install -y curl && \
    curl -L -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-7.14.0-amd64.deb && \
    dpkg -i packetbeat-7.14.0-amd64.deb && \
    rm -f packetbeat-7.14.0-amd64.deb && \
    apt-get purge -y --auto-remove curl && \
    rm -rf /var/lib/apt/lists/*

# Copy users configuration files
COPY ./tomcat-users.xml /usr/local/tomcat/conf/

# Copy the packetbeat configuration file
#COPY ./packetbeat.yml /etc/packetbeat/
COPY packetbeat.yml /etc/packetbeat/packetbeat.yml
RUN chown root /etc/packetbeat/packetbeat.yml && \
    chmod go-w /etc/packetbeat/packetbeat.yml && \
    setcap 'CAP_NET_RAW+eip CAP_NET_ADMIN+eip' /usr/bin/packetbeat

# Start packetbeat and catalina.sh in the foreground
CMD /etc/init.d/packetbeat start -e --strict.perms=false && catalina.sh run
#CMD service packetbeat start && /usr/local/tomcat/bin/catalina.sh run
